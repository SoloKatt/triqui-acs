<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triqui</title>
    <link rel="stylesheet" href="./styles/form.css">
</head>
<body>
    <div class = "triqui-board" id="triquiBoard">
        <div class="line vertical"></div>
        <div class="line vertical"></div>
        <div class="line horizontal"></div>
        <div class="line horizontal"></div>
        <div class="marker">
            <div class="marker x">X</div>
            <div class="marker x">X</div>
            <div class="marker x">X</div>
        </div>
        <div class="marker">
            <div class="marker o">O</div>
            <div class="marker o">O</div>
            <div class="marker o">O</div>
        </div>
    </div>
    <div class="container">
        <header>
            
        </header>
        
        <!-- Formulario de registro -->
        <div id="registerForm" class="form-container" style="display: none;">
            <h1>Triqui</h1>
            <h2 class="form-title">Registro</h2>
            <form id="register" class="form">
                <input type="text" id="registerUsername" class="form-input" placeholder="Nombre de usuario" required>
                <button type="submit" class="form-button">Registrar</button>
            </form>
            <p class="form-text">
                ¿Ya tienes cuenta? <a href="#" id="showLogin" class="form-link">Iniciar sesión</a>
            </p>
        </div>

        <!-- Formulario de inicio de sesión -->
        <div id="loginForm" class="form-container">
            <h1>Triqui</h1>
            <h2 class="form-title">Iniciar sesión</h2>
            <form id="login" class="form">
                <input type="text" id="loginUsername" class="form-input" placeholder="Nombre de usuario" required>
                <button type="submit" class="form-button">Entrar</button>
            </form>
            <div id="role-info"></div>
            <p class="form-text">
                ¿No tienes cuenta? <a href="#" id="showRegister" class="form-link">Regístrate</a>
            </p>
        </div>

        <!-- Área del juego -->
        <div id="lobby" class="game-container" style="display: none;">
            <h2>Bienvenido jugador: <span id="usernameDisplay"></span></h2>
            <div style="grid-row: auto;">
                <div id="gameContainer">
                    <h2>Jugador: <span id="usernameDisplay"></span></h2>
                    <div id="gameDetails"></div> <!-- Información de los jugadores -->
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Conexión con el servidor de WebSockets
        const socket = io();

        // Elementos del DOM
        const registerForm = document.getElementById('register');
        const registerUsername = document.getElementById('registerUsername');
        const loginForm = document.getElementById('login');
        const loginUsername = document.getElementById('loginUsername');
        const lobby = document.getElementById('lobby');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const registerDiv = document.getElementById('registerForm');
        const loginDiv = document.getElementById('loginForm');
        const triquiBoard = document.getElementById('triquiBoard'); // Tablero del triqui
        const gameContainer = document.getElementById('gameContainer');
        const gameDetails = document.getElementById('gameDetails'); // Contenedor de detalles del juego

        // Función para mostrar mensajes
        const showMessage = (message) => alert(message);

        // Función para alternar visibilidad de secciones
        const showSection = (sectionToShow) => {
            [registerDiv, loginDiv, lobby].forEach(section => {
                section.style.display = section === sectionToShow ? 'block' : 'none';
            });
            // Mostrar el tablero solo en las pantallas de registro y login
            if (sectionToShow === registerDiv || sectionToShow === loginDiv) {
                triquiBoard.style.display = 'block'; // Mostrar el tablero
            } else {
                triquiBoard.style.display = 'none'; // Ocultar el tablero
            }
        };

        // Alternar entre formularios
        document.getElementById('showLogin').addEventListener('click', (event) => {
            event.preventDefault();
            showSection(loginDiv);
        });

        document.getElementById('showRegister').addEventListener('click', (event) => {
            event.preventDefault();
            showSection(registerDiv);
        });

        // Manejar el registro
        registerForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const username = registerUsername.value.trim();

            if (!username) {
                showMessage('El nombre de usuario es obligatorio.');
                return;
            }

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username }),
                });

                const data = await response.json();
                if (response.status === 201) {
                    showMessage('Registro exitoso. Por favor, inicia sesión.');
                    showSection(loginDiv);
                } else {
                    showMessage(data.message || 'Error en el registro.');
                }
            } catch {
                showMessage('Error al conectar con el servidor.');
            }
        });

        // Manejar el inicio de sesión
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const username = loginUsername.value.trim();

            if (!username) {
                showMessage('El nombre de usuario es obligatorio.');
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username }),
                });

                const data = await response.json();
                if (response.status === 200) {
                    socket.emit('login', username);
                    usernameDisplay.textContent = username;
                    showSection(lobby);
                } else {
                    showMessage(data.message || 'Error al iniciar sesión.');
                }
            } catch {
                showMessage('Error al conectar con el servidor.');
            }
        });

        // Manejo de errores de conexión
        socket.on('error', (error) => {
            const { type, message } = error;

            showMessage(message || 'Error desconocido.');

            if (type === 'server_full') {
                window.location.href = '/full';
            }
            if (type === 'duplicate_user') {
                window.location.href = '/duplicateuser'
            }
        });

        // Mostrar la sala de espera
        const waitingDiv = document.createElement('div');
        waitingDiv.id = 'waitingRoom';
        waitingDiv.style.display = 'none';
        waitingDiv.innerHTML = '<h2>Esperando a otro jugador...</h2>';
        document.body.appendChild(waitingDiv);

        socket.on('waiting', (data) => {
            waitingDiv.style.display = 'block';
            lobby.style.display = 'none';
            showMessage(data.message);
        });

        // Iniciar el juego cuando ambos jugadores estén conectados
        socket.on('start game', (data) => {
            waitingDiv.style.display = 'none';
            lobby.style.display = 'none';
            showMessage(data.message);
            console.log('¡El juego ha comenzado!');
        });

        // Evento cuando inicia el juego (ocultar el tablero)
        socket.on('start game', (data) => {
            showSection(lobby); // Cambia a la zona de juego
            showMessage(data.message);
        });

        // Escuchar el evento de asignación de roles
        socket.on('role assigned', ({ role, order, opponentUsername }) => {
            console.log('Datos recibidos en role assigned:', { role, order, opponentUsername });

            // Verificar que los datos se reciben correctamente
            gameDetails.innerHTML = `
                <p>Tu ficha: <strong>${role}</strong></p>
                <p>Oponente: <strong>${opponentUsername}</strong></p>
                <p>Tu turno: <strong>${order === 'first' ? 'Primero' : 'Segundo'}</strong></p>
            `;
        });
    </script>
</body>
</html>
